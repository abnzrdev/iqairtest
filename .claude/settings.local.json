{
  "permissions": {
    "allow": [
      "Bash(ssh administrator@89.218.178.215 \"uname -a && whoami\")",
      "Bash(ssh administrator@89.218.178.215 \"ps aux | grep -E ''mongo|postgres'' | grep -v grep\")",
      "Bash(ssh administrator@89.218.178.215 \"which mongo mongod psql postgres\")",
      "Bash(ssh:*)",
      "WebFetch(domain:maps.app.goo.gl)",
      "Bash(scp:*)",
      "Bash(/tmp/fixed_data_endpoint.py << 'EOF'\n@app.post\\(\"/data\"\\)\nasync def ingest_sensor_data\\(\n    data: SensorData,\n    session: AsyncSession = Depends\\(get_session\\)\n\\):\n    \"\"\"\n    Endpoint для приема данных от Raspberry Pi.\n    Сохраняет данные в sensor_data и создает/обновляет сенсор в sensors.\n    \"\"\"\n    try:\n        from datetime import datetime\n        \n        # 1. Сохранить данные в sensor_data\n        sensor_data_record = SensorDataRecord\\(\n            device_id=data.device_id,\n            site=data.site,\n            pm1=data.pm1,\n            pm25=data.pm25,\n            pm10=data.pm10,\n            co2=data.co2,\n            voc=data.voc,\n            temp=data.temp,\n            hum=data.hum,\n            ch2o=data.ch2o,\n            co=data.co,\n            o3=data.o3,\n            no2=data.no2,\n            created_at=datetime.now\\(\\)\n        \\)\n        session.add\\(sensor_data_record\\)\n        \n        # 2. Координаты для устройств\n        device_coordinates = {\n            \"lab01\": {\n                \"coordinates\": [76.9288262, 43.252095],  # [lng, lat]\n                \"city\": \"Алматы\",\n                \"country\": \"Казахстан\"\n            }\n        }\n        \n        # 3. Найти или создать сенсор\n        sensor_name = f\"{data.device_id}_{data.site}\"\n        result = await session.execute\\(\n            select\\(Sensor\\).where\\(Sensor.name == sensor_name\\)\n        \\)\n        sensor = result.scalar_one_or_none\\(\\)\n        \n        if not sensor:\n            # Создать новый сенсор\n            coords = device_coordinates.get\\(data.device_id, {}\\)\n            sensor = Sensor\\(\n                name=sensor_name,\n                description=f\"Датчик качества воздуха {data.device_id} на локации {data.site}\",\n                price=0,\n                location={\n                    \"type\": \"Point\",\n                    \"coordinates\": coords.get\\(\"coordinates\", [76.9285, 43.2565]\\)\n                },\n                city=coords.get\\(\"city\", \"Алматы\"\\),\n                country=coords.get\\(\"country\", \"Казахстан\"\\),\n                parameters={\n                    \"pm1\": data.pm1,\n                    \"pm25\": data.pm25,\n                    \"pm10\": data.pm10,\n                    \"co2\": data.co2,\n                    \"voc\": data.voc,\n                    \"temp\": data.temp,\n                    \"hum\": data.hum,\n                    \"ch2o\": data.ch2o,\n                    \"co\": data.co,\n                    \"o3\": data.o3,\n                    \"no2\": data.no2\n                },\n                created_at=datetime.now\\(\\)\n            \\)\n            session.add\\(sensor\\)\n            await session.flush\\(\\)  # Получить ID сенсора\n            \n            # 4. Связать с первым пользователем\n            user_result = await session.execute\\(select\\(User\\).limit\\(1\\)\\)\n            first_user = user_result.scalar_one_or_none\\(\\)\n            if first_user:\n                # Использовать прямой INSERT в таблицу связей\n                await session.execute\\(\n                    user_sensor_permissions.insert\\(\\).values\\(\n                        user_id=first_user.id,\n                        sensor_id=sensor.id\n                    \\)\n                \\)\n        else:\n            # Обновить параметры существующего сенсора\n            sensor.parameters = {\n                \"pm1\": data.pm1,\n                \"pm25\": data.pm25,\n                \"pm10\": data.pm10,\n                \"co2\": data.co2,\n                \"voc\": data.voc,\n                \"temp\": data.temp,\n                \"hum\": data.hum,\n                \"ch2o\": data.ch2o,\n                \"co\": data.co,\n                \"o3\": data.o3,\n                \"no2\": data.no2\n            }\n        \n        await session.commit\\(\\)\n        \n        return {\n            \"ok\": True,\n            \"message\": \"Data received successfully\",\n            \"sensor_data_id\": sensor_data_record.id,\n            \"sensor_id\": sensor.id if sensor else None,\n            \"device_id\": data.device_id\n        }\n        \n    except Exception as e:\n        await session.rollback\\(\\)\n        print\\(f\"Error in ingest_sensor_data: {e}\"\\)\n        import traceback\n        traceback.print_exc\\(\\)\n        raise HTTPException\\(status_code=500, detail=f\"Error saving data: {str\\(e\\)}\"\\)\nEOF)",
      "Bash(/tmp/asyncpg_endpoint.py << 'EOF'\nimport asyncpg\n\n# В начале файла добавить connection pool\nasync def get_db_pool\\(\\):\n    return await asyncpg.create_pool\\(\n        \"postgresql://iqair_user:zwNxu4QJzMc35yN2@db:5432/iqair\",\n        min_size=1,\n        max_size=10\n    \\)\n\n# Endpoint\n@app.post\\(\"/data\"\\)\nasync def ingest_sensor_data\\(data: SensorData\\):\n    try:\n        pool = await get_db_pool\\(\\)\n        async with pool.acquire\\(\\) as conn:\n            row_id = await conn.fetchval\\(\"\"\"\n                INSERT INTO sensor_data \\(device_id, site, pm1, pm25, pm10, co2, voc, temp, hum, ch2o, co, o3, no2, created_at\\)\n                VALUES \\($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, CURRENT_TIMESTAMP\\)\n                RETURNING id\n            \"\"\", data.device_id, data.site, data.pm1, data.pm25, data.pm10, data.co2, data.voc, data.temp, data.hum, data.ch2o, data.co, data.o3, data.no2\\)\n            return {\"ok\": True, \"id\": row_id, \"device_id\": data.device_id}\n    except Exception as e:\n        import traceback\n        traceback.print_exc\\(\\)\n        raise HTTPException\\(status_code=500, detail=str\\(e\\)\\)\nEOF)",
      "Bash(curl:*)",
      "Bash(python3:*)"
    ]
  }
}
